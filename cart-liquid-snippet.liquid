{% comment %}
  Add this code to your cart.liquid file in your Shopify theme
  Place it near the end of the file, just before the closing </form> tag
{% endcomment %}

<!-- Foxx Newsletter Cart Validation -->
<div id="foxx-cart-validation-container">
  <!-- Validation messages will be inserted here by JavaScript -->
</div>

<script>
  // Make cart data available to our validation script
  window.cart = {{ cart | json }};
  window.cartTotal = {{ cart.total_price | money_without_currency | remove: ',' }};
</script>

<!-- Include the main validation script -->
<script>
/**
 * Foxx Newsletter Cart Validation - Inline Version for cart.liquid
 * This script checks subscription status and cart value to show appropriate messages
 */
(function() {
  'use strict';
  
  // Configuration - Update with your actual store ID from popup builder
  const STORE_ID = '{{ shop.permanent_domain | replace: '.myshopify.com', '' }}'; // Auto-detect from Shopify
  // Or manually set: const STORE_ID = 'fa37fc5c-90ce-44d2-83d8-34835f3b45af';
  
  const CART_THRESHOLD = 1000; // $1000 threshold from your popup settings
  const DISCOUNT_CODE = 'WELCOME15'; // Your discount code
  
  // Session storage keys (matching your popup system)
  const STORAGE_KEY = `foxx_newsletter_fa37fc5c-90ce-44d2-83d8-34835f3b45af`; // Use your actual store ID
  
  function isUserSubscribed() {
    try {
      const hasSession = sessionStorage.getItem(STORAGE_KEY + '_session') === 'true';
      const hasCartValidation = sessionStorage.getItem(STORAGE_KEY + '_cart_validation_session') === 'true';
      const hasLocalStorage = localStorage.getItem(STORAGE_KEY) !== null;
      return hasSession || hasCartValidation || hasLocalStorage;
    } catch (error) {
      return false;
    }
  }
  
  function getCartTotal() {
    return parseFloat(window.cartTotal || {{ cart.total_price | money_without_currency | remove: ',' }});
  }
  
  function showValidationMessage() {
    const existingMessage = document.getElementById('foxx-cart-validation-message');
    if (existingMessage) existingMessage.remove();
    
    const cartTotal = getCartTotal();
    
    const messageDiv = document.createElement('div');
    messageDiv.id = 'foxx-cart-validation-message';
    messageDiv.className = 'cart-validation-notice';
    messageDiv.innerHTML = `
      <div class="notice notice--error" style="background: #f8d7da; border: 1px solid #f1aeb5; color: #721c24; padding: 15px; margin: 15px 0; border-radius: 8px;">
        <div style="display: flex; align-items: flex-start; gap: 10px;">
          <span style="font-size: 18px;">⚠️</span>
          <div>
            <strong>Discount Code Not Applicable</strong><br>
            Your cart total is <strong>${'$' + cartTotal.toFixed(2)}</strong>, which exceeds our $${CART_THRESHOLD.toLocaleString()} threshold. 
            <br><br>
            The discount code <strong>${DISCOUNT_CODE}</strong> you received from our newsletter signup is only valid for orders under <strong>$${CART_THRESHOLD.toLocaleString()}</strong>.
            <br><br>
            <em>Please reduce your cart value to apply the discount code at checkout.</em>
          </div>
        </div>
      </div>
    `;
    
    // Insert the message at the top of the cart form
    const cartForm = document.querySelector('form[action="/cart"]');
    if (cartForm) {
      cartForm.insertBefore(messageDiv, cartForm.firstChild);
    }
  }
  
  function checkAndShowValidation() {
    const isSubscribed = isUserSubscribed();
    const cartTotal = getCartTotal();
    
    console.log('Foxx Validation Check:', {
      subscribed: isSubscribed,
      cartTotal: cartTotal,
      threshold: CART_THRESHOLD,
      shouldShow: isSubscribed && cartTotal > CART_THRESHOLD
    });
    
    if (isSubscribed && cartTotal > CART_THRESHOLD) {
      showValidationMessage();
    }
  }
  
  // Run the validation
  document.addEventListener('DOMContentLoaded', checkAndShowValidation);
  
  // Also run on cart updates
  document.addEventListener('cart:updated', checkAndShowValidation);
  
})();
</script>

<style>
  .cart-validation-notice {
    margin-bottom: 20px;
  }
  
  .cart-validation-notice .notice {
    font-family: inherit;
    font-size: 14px;
    line-height: 1.4;
  }
  
  .cart-validation-notice strong {
    font-weight: 600;
  }
</style>